<apex:page standardController="Opportunity" extensions="OpportunityEditExt"
           lightningStylesheets="{!$User.UIThemeDisplayed == 'Theme4d'}"
           tabStyle="Opportunity" showHeader="true" sidebar="true" 
           title="{!$objectType.Opportunity.Label}: {!opp.Name}">
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"/>
    <apex:variable value="{!$User.UIThemeDisplayed == 'Theme4d'}" var="isLightningTheme" />
    <apex:slds rendered="{!isLightningTheme}"/>

    <script>
        jQuery.noConflict();
    </script>

    <style>
        .fieldLabel { font-size: 91%; font-weight: bold; color: #4a4a56 !important; }
        .activeTab {
            background-color: #236FBD;
            color: white;
            background-image: none
        }
        .inactiveTab {
            background-color: lightgrey;
            color: black;
            background-image: none
        }
        .modal-dialog-pos {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
        }
        .forceMessage.desktopBoxed.strength_3 {
            padding: 15px 20px;
        }
        .forceMessage.desktopBoxed.error {
            background-color: rgb(194, 57, 52);
            border-color: rgb(194, 57, 52);
        }
        .forceMessage.desktopBoxed {
            border: 0;
            border-radius: 3px;
            margin: 0;
            color: #fff;
        }
        .forceMessage.error {
            border-color: #f2a199;
            background-color: #fdedea;
        }
        .uiMessage.error {
            border-color: #f2a199;
            background-color: #fdedea;
        }
        .forceMessage {
            color: #464646;
            padding: 5px;
            margin: 10px;
            border: 1px solid;
            border-radius: 5px;
            font-size: 13px;
            line-height: 18px;
        }
        .uiMessage {
            color: #464646;
            padding: 5px;
            margin: 5px;
            border-width: 1px;
            border-style: solid;
            border-radius: 5px;
            font-size: 13px;
            line-height: 18px;
            border-color: #ccc;
            background-color: #eee;
            opacity: 1;
            -webkit-transition: opacity .2s ease-out;
            transition: opacity .2s ease-out;
        }
        .uiBlock {
            overflow: hidden;
            vertical-align: top;
        }
        .uiBlock .bLeft {
            float: left;
        }
        .uiBlock .bLeft img {
            display: block;
        }
        .forceMessage.desktopBoxed.error.strength_3 .bLeft .icon {
            background: url(/relatedlist/images/message/red-error.png) no-repeat;
            width: 34px;
            height: 34px;
        }
        .forceMessage.desktopBoxed.strength_3 .bLeft .icon {
            margin-right: 20px;
        }
        body .zen-btn, .slds-vf-scope .zen-btn {
            -webkit-appearance: none;
            position: relative;
            display: inline-block;
            border: 1px solid transparent;
            padding: 0;
            margin-top: 1em;
            font-size: .75rem;
            line-height: 1.875rem;
            text-decoration: none;
            white-space: normal;
            border-radius: .25rem;
            background: transparent;
            background-clip: border-box;
            color: rgba(27, 82, 151, 1.0);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-transition: color .05s linear,background-color .05s linear;
            transition: color .05s linear,background-color .05s linear;
            padding-left: 1rem;
            padding-right: 1rem;
            text-align: center;
            vertical-align: middle;
            border: 1px solid rgb(221, 219, 218);
            -webkit-transition: border 0.15s linear;
            transition: border 0.15s linear;
            background-color: rgba(27, 82, 151, 1.0);
            border-color: rgba(27, 82, 151, 1.0);
            color: rgb(255, 255, 255);
        }
        body.slds-scope, .slds-vf-scope.vf-body, .slds-vf-scope.sfdcBody {
            height: 100%;
            overflow: auto;
            padding: .75rem .75rem 0;
        }
        td.rich-tabhdr-side-cell {
            padding: 0 .75rem;
        }

    </style>

    <p id="removeInlineEditFocus"/>

    <apex:actionStatus id="statusSection" startText="Please Wait..." StopText="" >
        <apex:facet name="start">
            <div class="modal-dialog-pos" style="opacity: 0.25; opacity: 0.25; background-color: black;">&nbsp;</div>
            <div style="position: fixed; left: 0; top: 0; bottom: 0; right: 0; z-index: 1001; margin: 15% 50%">
                <div style="display: inline-block; padding: 2px; background-color: #fff; width: 125px;">
                    <img src="/img/loading.gif" style="float: left; margin: 8px;" />
                    <span style="display: inline-block; padding: 10px 0px;">Please Wait...</span>
                </div>
            </div>
        </apex:facet>
    </apex:actionStatus>

    <apex:sectionHeader title="{!$objectType.Opportunity.Label & ': ' & opp.Strike_ID__c}" subtitle="{!opp.Name}"/>
    <!-- title="{!$objectType.Opportunity.Label}" -->

    <chatter:feedWithFollowers entityId="{!opp.id}"/>

    <apex:form id="mainForm">
        <apex:outputPanel rendered="{!isLightningTheme}">
            <div class="slds-scope">
                <div class="slds-hide modal-dialog-pos" style="height: 640px;" id="change-owner-dialog">
                    <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                        <div class="slds-modal__container">
                            <header class="slds-modal__header">
                                <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Change Opportunity Owner</h2>
                            </header>
                            <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                                <div style="height: 4.5rem; display:none;" id="error-modal-id" >
                                    <div class="modalError">
                                        <div class="error strength_3 desktopBoxed uiMessage forceMessage" role="alert" data-aura-class="uiMessage forceMessage">
                                            <div class="uiBlock">
                                                <div class="bLeft">
                                                <span class="uiImage" data-aura-class="uiImage">
                                                    <img src="/auraFW/resources/aura/s.gif" class="icon" alt="error" style="max-width: 100%;"/>
                                                </span>
                                                </div>
                                                <div class="bRight"/>
                                                <div class="bBody">
                                                    <p class="body"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 3rem;">
                                    <div class="slds-form-element">
                                        <div class="slds-form-element__control">
                                            <div class="slds-combobox_container">
                                                <div class="slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click" aria-expanded="false" aria-haspopup="listbox" role="combobox">
                                                    <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                                        <input class="slds-input slds-combobox__input" id="combobox-id" autocomplete="off" role="textbox" type="text" placeholder="Search... "
                                                               onkeyup="ChangeOwner.keyHandle(this);"
                                                        />

                                                        <div role="status" class="slds-spinner slds-spinner_brand slds-spinner_x-small slds-input__spinner" id="os-spinner-small" style="display:none">
                                                            <span class="slds-assistive-text">Loading</span>
                                                            <div class="slds-spinner__dot-a"></div>
                                                            <div class="slds-spinner__dot-b"></div>
                                                        </div>
                                                    </div>
                                                    <div id="listbox-id" class="slds-dropdown slds-dropdown_length-with-icon-7 slds-dropdown_fluid" role="listbox" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 3rem;">
                                    <div class="slds-form-element">
                                        <div class="slds-form-element__control">
                                            <div class="slds-text-body_regular"><b>The new owner</b> will also become the owner of these records related to <b>{!opp.Name}</b> that are owned by <b>you</b>.</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 3rem;">
                                    <div class="slds-form-element">
                                        <div class="slds-form-element__control">
                                            <ul class="slds-list_dotted">
                                                <li>Notes and attachments</li>
                                                <li>Open activities</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <footer class="slds-modal__footer">
                                <button class="slds-button slds-button_neutral" onclick="event.preventDefault(); ChangeOwner.close();">Cancel</button>
                                <button class="slds-button slds-button_brand" onclick="event.preventDefault(); ChangeOwner.submit();">Submit</button>
                            </footer>

                            <div role="status" class="slds-spinner slds-spinner_brand slds-spinner_large slds-input__spinner" id="os-spinner-large" style="display:none">
                                <div class="slds-spinner__dot-a"></div>
                                <div class="slds-spinner__dot-b"></div>
                            </div>
                        </div>
                    </section>
                    <div class="slds-backdrop slds-backdrop_open"></div>
                </div>
            </div>
        </apex:outputPanel>

        <apex:pageBlock mode="maindetail">
            <apex:pageMessages escape="false" id="contractMessage" />
            <apex:pageBlockButtons location="top">
                <apex:commandButton value="Save" id="saveBtn" styleClass="saveButton" reRender="mainForm" style="display:none;" action="{!saveOpportunity}" status="statusSection" onclick="removeInlineEditFocus();"/>
                <apex:commandButton value="Cancel" id="cancelBtn" action="{!cancel}" style="display:none;" reRender="mainForm" />
                <apex:commandButton value="Change Owner" id="ChangeOwner" action="{!URLFOR($Action.Opportunity.ChangeOwner, Id)}" rendered="{!NOT(isLightningTheme)}"/>
                <apex:commandButton value="Change Owner" id="ChangeOwnerLght" onclick="event.preventDefault(); ChangeOwner.dialog();" rendered="{!isLightningTheme}"/>
                <apex:commandButton value="Clone" id="clone" action="{!cloneOpportunity}"/>


                <apex:commandButton value="Delete" id="delete" action="{!URLFOR($Action.Opportunity.Delete, Id)}" rendered="{!OR($Profile.Name ='System Administrator',$User.Alias = 'JNesb')}"/>
            </apex:pageBlockButtons>
        </apex:pageBlock>

        <apex:tabPanel switchType="client" selectedTab="Overview" id="contractInfoPanel">
            <apex:tab label="Overview" name="overview" id="tabOverview" ontabenter="tabChanged('overview')">

                <apex:pageBlock id="saasBlock" rendered="{!opp.RecordType.Name = 'SaaS'}">
                    <apex:inlineEditSupport showOnEdit="saveBtn, cancelBtn" hideOnEdit="editBtn, deleteBtn, mmButton, xeroButton" event="ondblclick" resetFunction="resetInlineEdit" id="inlineElement" />

                    <apex:pageBlockSection title="General Info" collapsible="true" id="generalInfo">
                        <apex:outputField value="{!opp.Name}"/>
                        <apex:outputField value="{!opp.StageName}"/>
                        <apex:outputField value="{!opp.AccountId}"/>
                        <apex:outputField value="{!opp.Closed_Lost_Reason__c}"/>
                        <apex:outputField value="{!opp.Momentum__c}"/>
                        <apex:outputField value="{!opp.OwnerId}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Qualification" collapsible="true" id="qualification">
                        <apex:outputField value="{!opp.Probability__c}"/>
                        <apex:outputField value="{!opp.Additional_Rep__c}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.InsideSalesRep__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.stagename=='Qualification')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.saasBlock.qualification}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Discovery Call" collapsible="true" id="discoveryCall">
                        <apex:outputField value="{!opp.MeetingDate__c}"/>
                        <apex:outputField value="{!opp.Further_Steps__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.stagename=='Discovery Call')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.saasBlock.discoveryCall}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Evaluation" collapsible="true" id="evaluation">
                        <apex:outputField value="{!opp.Annual_TrueView_Spend__c}"/>
                        <apex:outputField value="{!opp.KPI_picklist__c}"/>
                        <apex:outputField value="{!opp.Features_Wanted__c}"/>
                        <apex:outputField value="{!opp.Features_Needed__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.stagename=='Evaluation')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.saasBlock.evaluation}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Validating Benefits" collapsible="true" id="validatingBenefits">
                        <apex:outputField value="{!opp.Flight_Start__c}"/>
                        <apex:outputField value="{!opp.Flight_End__c}"/>
                        <apex:outputField value="{!opp.Trial_Notes__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.stagename=='Validating Benefits')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.saasBlock.validatingBenefits}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Negotiating & Mutual Plan" collapsible="true" id="negotiation">
                        <apex:pageBlockSection title="Spend Threshold" collapsible="false" columns="1" id="SpendThresholdsSection">
                            <apex:inlineEditSupport showOnEdit="saveBtn, cancelBtn" hideOnEdit="editBtn, deleteBtn, mmButton, xeroButton" event="ondblclick" resetFunction="resetInlineEdit" id="inlineElement" />

                            <apex:pageBlockSectionItem >
                                <apex:outputLabel styleClass="btn" onclick="addNewSpendThreshold();"> + </apex:outputLabel>
                                <apex:actionRegion >
                                    <apex:outputPanel id="SpendThresholdsPanel">
                                        <table class="list" border="1" cellpadding="0" cellspacing="0" id="mainTable_Spend_Threshold__c">
                                            <tr class="headerRow" >
                                                <th>{!$objectType.Spend_Threshold__c.Fields.Spend_From__c.Label}</th>
                                                <th>{!$objectType.Spend_Threshold__c.Fields.Spend_To__c.Label}</th>
                                                <th>{!$objectType.Spend_Threshold__c.Fields.Fee__c.Label}</th>
                                                <th></th>
                                            </tr>
                                            <apex:variable var="spendThresholdRow" value="{!0}"/>
                                            <apex:repeat value="{!spendThresholds}" var="spendThreshold">
                                                <tr class="dataRow">
                                                    <td><apex:outputField value="{!spendThreshold.Spend_From__c}"/></td>
                                                    <td><apex:outputField value="{!spendThreshold.Spend_To__c}" /></td>
                                                    <td><apex:outputField value="{!spendThreshold.Fee__c}"/></td>
                                                    <td><apex:outputLabel onclick="deleteSpendThreshold('{!spendThresholdRow}');" styleClass="btn"><a>Del</a></apex:outputLabel></td>
                                                </tr>
                                                <apex:variable var="spendThresholdRow" value="{!spendThresholdRow+1}"/>
                                            </apex:repeat>
                                        </table>
                                    </apex:outputPanel>
                                    <apex:actionFunction name="addNewSpendThreshold" action="{!addNewSpendThreshold}" reRender="SpendThresholdsPanel" status="myStatus2"/>
                                    <apex:actionFunction name="deleteSpendThreshold" action="{!deleteSpendThreshold}" reRender="SpendThresholdsPanel" status="myStatus2">
                                        <apex:param name="spendThresholdRow" assignTo="{!spendThresholdRow}" value=""/>
                                    </apex:actionFunction>
                                </apex:actionRegion>
                            </apex:pageBlockSectionItem>
                        </apex:pageBlockSection>

                        <apex:outputField value="{!opp.Negotiation_Notes__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.stagename=='Negotiating & Mutual Plan')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.saasBlock.negotiation}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Closed Lost" collapsible="true" id="closedLost">
                        <apex:outputField value="{!opp.Closed_Lost_Reason__c}"/>
                        <apex:outputField value="{!opp.Lost_Notes__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.stagename=='Closed Lost')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.saasBlock.closedLost}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                </apex:pageBlock>

                <apex:pageBlock id="agencyBlock" rendered="{!OR(opp.RecordType.Name = 'Agency', opp.RecordType.Name = NULL)}">
                    <apex:inlineEditSupport showOnEdit="saveBtn, cancelBtn" hideOnEdit="editBtn, deleteBtn, mmButton, xeroButton" event="ondblclick" resetFunction="resetInlineEdit" id="inlineElement" />

                    <apex:pageBlockSection title="Information" collapsible="true">
                        <apex:outputField value="{!opp.Name}"/>
                        <apex:outputField value="{!opp.StageName}"/>
                        <apex:outputField value="{!opp.AccountId}"/>
                        <apex:outputField value="{!opp.Closed_Lost_Reason__c}"/>
                        <apex:outputField value="{!opp.Brand__c}"/>
                        <apex:outputField value="{!opp.Amount}"/>
                        <apex:outputField value="{!opp.Account_Type__c}"/>
                        <apex:outputField value="{!opp.Percent_Margin__c}"/>
                        <apex:outputField value="{!opp.BillingCondition__c}"/>
                        <apex:outputField value="{!opp.Margin_Type__c}"/>
                        <apex:outputField value="{!opp.Media_Process_Type__c}"/>
                        <apex:outputField value="{!opp.Flight_Start__c}"/>
                        <apex:outputField value="{!opp.Email_Notifications_Off__c}" rendered="{!OR($Profile.Name ='System Administrator', $User.Alias = 'thelf')}"/>
                        <apex:outputLabel rendered="{!AND($Profile.Name !='System Administrator', $User.Alias != 'thelf')}"/>
                        <apex:outputField value="{!opp.Flight_End__c}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Sales Process Information" collapsible="true">
                        <apex:outputField value="{!opp.MeetingDate__c}"/>
                        <apex:outputField value="{!opp.Probability__c}"/>
                        <apex:outputField value="{!opp.MeetingStatus__c}"/>
                        <apex:outputField value="{!opp.CloseDate}"/>
                        <apex:outputField value="{!opp.MeetingNotes__c}"/>
                        <apex:outputField value="{!opp.RFP_Due_Date__c}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Reps Information" collapsible="true" columns="2">
                        <apex:outputField value="{!opp.OwnerId}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.Additional_Rep__c}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.Non_Salesforce_Rep__c}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.InsideSalesRep__c}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.ClientServicesRep__c}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Brief Campaign Overview" collapsible="true">
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="{!$objectType.Platform__c.LabelPlural}"/>
                            <apex:outputText value="{!platformString}"/>
                        </apex:pageBlockSectionItem>
                        <apex:outputField value="{!opp.Verticals__c}"/>
                        <apex:outputLabel />
                        <apex:outputText value="{!opp.Brand__r.Verticals__c}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Financial Information" collapsible="true">
                        <apex:outputField value="{!opp.IO__c}"/>
                        <apex:outputField value="{!opp.Media_Spendings__c}"/>
                        <apex:outputField value="{!opp.Payment_Type__c}"/>
                        <apex:outputField value="{!opp.Expected_Revenue__c}"/>
                        <apex:outputField value="{!opp.InvoicingType__c}"/>
                        <apex:outputField value="{!opp.Gross_Profit__c}"/>
                        <apex:outputField value="{!opp.Order_Type__c}"/>
                        <apex:outputLabel rendered="{!opp.BillingCondition__r.Rebate_Rate__c = NULL}"/>
                        <apex:outputField value="{!opp.ExpectedRebate__c}" rendered="{!opp.BillingCondition__r.Rebate_Rate__c != NULL}"/>
                        <apex:outputField value="{!opp.CustomXeroCampaignName__c}" rendered="{!opp.Account.Custom_Xero_Naming__c}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Distribution & Targeting" collapsible="true">
                        <apex:outputField value="{!opp.Geo__c}"/>
                        <apex:outputField value="{!opp.Video_Length__c}"/>
                        <apex:outputField value="{!opp.Targeting__c}"/>
                        <apex:outputField value="{!opp.Language__c}"/>
                        <apex:outputField value="{!opp.KPI__c}"/>
                        <apex:outputField value="{!opp.Gender__c}"/>
                        <apex:outputField value="{!opp.More_Info__c}"/>
                    </apex:pageBlockSection>
                </apex:pageBlock>

                <apex:pageBlock id="brandDirectBlock" rendered="{!opp.RecordType.Name = 'Brand Direct'}">
                    <apex:inlineEditSupport showOnEdit="saveBtn, cancelBtn" hideOnEdit="editBtn, deleteBtn, mmButton, xeroButton" event="ondblclick" resetFunction="resetInlineEdit" id="inlineElement" />

                    <apex:pageBlockSection title="Qualification" collapsible="false" id="bd_qualification">
                        <apex:outputField value="{!opp.Name}"/>
                        <apex:outputField value="{!opp.StageName}"/>
                        <apex:outputField value="{!opp.AccountId}"/>
                        <apex:outputField value="{!opp.OwnerId}"/>
                        <apex:outputField value="{!opp.Brand__c}" />
                        <apex:outputField value="{!opp.Amount}"/>
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Expected Close Date"/>
                            <apex:outputField value="{!opp.CloseDate}"/>
                        </apex:pageBlockSectionItem>
                        <apex:outputField value="{!opp.Qualification_Notes__c}"/>
                        <apex:outputField value="{!opp.Probability__c}"/>
                    </apex:pageBlockSection>

                    <apex:pageBlockSection title="Discovery Call" collapsible="true" id="bd_discoveryCall">
                        <apex:outputField value="{!opp.InsideSalesRep__c}"/>
                        <apex:outputField value="{!opp.MeetingDate__c}"/>
                        <apex:outputField value="{!opp.Additional_Rep__c}"/>
                        <apex:outputField value="{!opp.MeetingNotes__c}"/>
                        <apex:outputField value="{!opp.Non_Salesforce_Rep__c}"/>
                        <apex:outputField value="{!opp.Competitor_Description__c}"/>
                        <apex:outputField value="{!opp.ClientServicesRep__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.StageName == 'Discovery Call')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.brandDirectBlock.bd_discoveryCall}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Evaluation" collapsible="true" id="bd_evaluation">
                        <apex:outputField value="{!opp.Client_s_Top_Priority__c}"/>
                        <apex:outputField value="{!opp.Client_s_Top_Priority_Details__c}"/>
                        <apex:outputField value="{!opp.Client_s_Biggest_Challenge__c}"/>
                        <apex:outputField value="{!opp.Client_s_Biggest_Challenge_Details__c}"/>
                        <apex:outputField value="{!opp.Platform__c}"/>
                        <apex:outputField value="{!opp.Client_s_Ad_Account_Numbers__c}"/>
                        <apex:outputField value="{!opp.Audit__c}"/>
                        <apex:outputField value="{!opp.Proposal__c}"/>
                        <apex:outputField value="{!opp.RFP_Due_Date__c}"/>
                        <apex:outputField value="{!opp.KPI__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!NOT(opp.StageName == 'Evaluation')}">
                        <script>
                        twistSection(document.getElementById('{!$Component.brandDirectBlock.bd_evaluation}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Validating Benefits" collapsible="true" id="bd_validatingBenefits">
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Next Meeting Date"/>
                            <apex:outputField value="{!opp.MeetingDate__c}"/>
                        </apex:pageBlockSectionItem>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!opp.StageName != 'Validating Benefits'}">
                        <script>
                        twistSection(document.getElementById('{!$Component.brandDirectBlock.bd_validatingBenefits}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Negotiating & Mutual Plan" collapsible="true" id="bd_negotiating">
                        <apex:outputField value="{!opp.Account_Type__c}"/>
                        <apex:outputField value="{!opp.Final_Negotiating_Considerations__c}"/>
                        <apex:outputField value="{!opp.BillingCondition__c}"/>
                        <apex:outputField value="{!opp.Order_Type__c}" />
                        <apex:outputField value="{!opp.Payment_Type__c}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.InvoicingType__c}"/>
                        <apex:outputLabel />
                        <apex:outputField value="{!opp.CustomXeroCampaignName__c}" rendered="{!opp.Account.Custom_Xero_Naming__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText >
                        <script>
                        twistSection(document.getElementById('{!$Component.brandDirectBlock.bd_negotiating}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Finalizing Closure" collapsible="true" id="bd_finalizingClosure">
                        <apex:outputField value="{!opp.Flight_Start__c}"/>
                        <apex:outputField value="{!opp.Amount}"/>
                        <apex:outputField value="{!opp.Flight_End__c}"/>
                        <apex:outputField value="{!opp.Percent_Margin__c}"/>
                        <apex:outputField value="{!opp.Language__c}"/>
                        <apex:outputField value="{!opp.Margin_Type__c}"/>
                        <apex:outputField value="{!opp.Targeting__c}"/>
                        <apex:outputField value="{!opp.Media_Spendings__c}"/>
                        <apex:outputField value="{!opp.Geo__c}"/>
                        <apex:outputField value="{!opp.Expected_Revenue__c}"/>
                        <apex:outputField value="{!opp.Verticals__c}"/>
                        <apex:outputField value="{!opp.Gross_Profit__c}"/>
                        <apex:outputText label="Company Verticals" value="{!opp.Brand__r.Verticals__c}"/>
                        <apex:outputField value="{!opp.Video_Length__c}"/>
                        <apex:outputField value="{!opp.Gender__c}"/>
                        <apex:outputField value="{!opp.More_Info__c}"/>
                        <apex:outputField value="{!opp.ExpectedRebate__c}" rendered="{!opp.BillingCondition__r.Rebate_Rate__c != NULL}"/>
                    </apex:pageBlockSection>

                    <apex:outputText >
                        <script>
                        twistSection(document.getElementById('{!$Component.brandDirectBlock.bd_finalizingClosure}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                    <apex:pageBlockSection title="Closed" collapsible="true" id="closed">
                        <apex:outputField value="{!opp.IO__c}"/>
                        <apex:outputField value="{!opp.Closed_Lost_Reason__c}"/>
                    </apex:pageBlockSection>

                    <apex:outputText rendered="{!AND(NOT(opp.StageName == 'Closed Won'),NOT(opp.StageName == 'Closed Lost'))}">
                        <script>
                        twistSection(document.getElementById('{!$Component.brandDirectBlock.closed}').getElementsByTagName('img')[0])
                        </script>
                    </apex:outputText>

                </apex:pageBlock>
            </apex:tab>

            <apex:tab label="{!$objectType.Platform__c.LabelPlural}" name="platforms" id="tabPlatforms" ontabenter="tabChanged('platforms')" rendered="{!opp.RecordType.Name != 'SaaS'}">
                <apex:pageMessages id="platformMessages"/>

                <apex:pageBlock >
                    <apex:pageBlockButtons location="top">
                        <apex:commandButton value="Save" action="{!savePlatforms}" status="statusSection" reRender="platformMessages,platformSections"/>
                    </apex:pageBlockButtons>

                    <apex:pageBlockSection title="{!$objectType.Platform__c.LabelPlural}" columns="2" collapsible="false">
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="{!$objectType.Platform__c.Label}" styleClass="fieldLabel"/>
                            <apex:outputPanel >
                                <apex:repeat value="{!platforms}" var="platform">
                                    <apex:outputPanel layout="inline">
                                        <apex:inputCheckbox value="{!platform.isSelected}" onclick="platformUpdated();"/>
                                        <apex:outputLabel value="{!platform.oppPlatform.Platform__r.Name}"/>
                                    </apex:outputPanel>
                                    <br/>
                                </apex:repeat>
                                <apex:actionFunction name="platformUpdated" action="{!platformUpdated}" rerender="platformSections,platformMessages" status="statusSection"/>
                            </apex:outputPanel>
                        </apex:pageBlockSectionItem>
                    </apex:pageBlockSection>

                    <apex:outputPanel id="outer">
                        <apex:outputPanel id="platformSections">
                            <apex:repeat value="{!platforms}" var="platform">
                                <c:PlatformSection platform="{!platform}"/>
                            </apex:repeat>
                        </apex:outputPanel>
                    </apex:outputPanel>

                </apex:pageBlock>
            </apex:tab>

            <apex:tab label="Creatives" name="creative" id="tabCreative" ontabenter="tabChanged('creative')" rendered="{!opp.RecordType.Name != 'SaaS'}">
                <apex:pageblock >
                    <apex:pageBlockSection >
                        <apex:outputField value="{!opp.Flight_Start__c}"/>
                        <apex:outputField value="{!opp.Flight_End__c}"/>
                    </apex:pageBlockSection>
                </apex:pageblock>
            </apex:tab>

            <apex:tab label="Tasks & Meetings" name="activity" id="tabActivity" ontabenter="tabChanged('activities')">
            </apex:tab>

            <apex:tab label="History" name="history" id="tabHistory" ontabenter="tabChanged('history')">
                <apex:pageBlock >
                    <apex:pageBlockSection collapsible="false" title="System Information" columns="2">
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Created By"/>
                            <apex:outputPanel >
                                <apex:outputField value="{!opp.CreatedById}"/>,&nbsp;
                                <apex:outputField value="{!opp.CreatedDate}"/>
                            </apex:outputPanel>
                        </apex:pageBlockSectionItem>
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Last Modified By"/>
                            <apex:outputPanel >
                                <apex:outputField value="{!opp.LastModifiedById}"/>,&nbsp;
                                <apex:outputField value="{!opp.LastModifiedDate}"/>
                            </apex:outputPanel>
                        </apex:pageBlockSectionItem>
                    </apex:pageBlockSection>
                </apex:pageBlock>
            </apex:tab>

            <script>
            function tabChanged(tabName) {
                jQuery("[class$='TabRelatedLists']").hide();
                jQuery('.' + tabName + 'TabRelatedLists').show();
            }

            function showSaveButton() {
                jQuery(".saveButton").show();
            }
            </script>
        </apex:tabPanel>
    </apex:form>


    <apex:outputPanel styleClass="creativeTabRelatedLists" style="display: none;">
        <c:VideoUrlsComponent opportunityId="{!opp.Id}"/>
    </apex:outputPanel>

    <apex:outputPanel styleClass="activitiesTabRelatedLists" style="display: none;">
        <apex:relatedList list="OpenActivities"/>
        <apex:relatedList list="ActivityHistories"/>
        <apex:relatedList list="Contact_Opportunities__r"/>
        <apex:relatedList subject="{!opportunity}" list="CombinedAttachments" />
    </apex:outputPanel>

    <apex:outputPanel styleClass="historyTabRelatedLists" style="display: none;">
        <apex:relatedList list="OpportunityHistories"/>
        <apex:relatedList list="Projects__r" rendered="{!opp.RecordType.Name != 'SaaS'}"/>
    </apex:outputPanel>

    <script type="text/javascript">
    jQuery(document).ready(function() {
        PageBlockSection.setHelpHint("bd_qualification", "In the Qualification stage the prospect has identified themselves as interested and an opportunity is " +
                                     "created to record this. SDR’s create the opportunity and track the account until an initial discovery call can be scheduled " +
                                     "with an AE.");

        PageBlockSection.setHelpHint("bd_discoveryCall", "In the Discovery Call stage, a hand-off from a Sales Development Representative to an Account Executive " +
                                     "occurs here. In this stage Meeting date is set and a Google Doc with notes for the team to view and collaborate on is " +
                                     "generated. SDR’s please be specific on who will be attending the meeting, their titles, and how you came across this account " +
                                     "in the first place.");

        PageBlockSection.setHelpHint("bd_evaluation", "In the Evaluation stage an automatic email can be generated to communicate the need for an audit or proposal " +
                                     "to Strike Social teams members. A salesperson should ensure the next steps are very clear and your ask of the strategy and " +
                                     "client service teams is focused and specific.");

        PageBlockSection.setHelpHint("bd_validatingBenefits", "In the Validating Benefits stage we present our findings and plan for moving forward. Lastly, " +
                                     "we confirm the benefit that Strike Social will bring to their unique KPI’s.");

        PageBlockSection.setHelpHint("bd_negotiating", "In this stage the final touches are being place on our client agreement. The platforms, campaign goals, " +
                                     "and budget should be well understood when we are in this stage.");

        PageBlockSection.setHelpHint("bd_finalizingClosure", "In this stage an automated email is sent to clientservices@strikesocial.com to tell them to generate " +
                                     "an IO and send it to the client.");

    });

    var PageBlockSection = (function(isLightningTheme) {
        let isFirefox = typeof InstallTrigger !== 'undefined';

        let setHelpHint = function(sectionId, hint) {
            let randomId = Math.random().toString(36).substr(2, 9);

            let img = document.createElement("img");
            if (isLightningTheme === false) {
                img.style.position = "absolute";
                img.style.width = "2em";
                img.style.height = "1.5em";
                if (isFirefox) {
                    img.style.top = "-1.1em";
                } else {
                    img.style.top = "-0.3em";
                }
                img.style.background = "url('/img/help_orange.png') top right no-repeat";
            } else {
                img.style.position = "relative";
            }
            img.src = "/img/s.gif"
            img.className = "helpOrb";

            let span = document.createElement("span");
            span.className = "helpButton";
            span.id = randomId  + "-_help"; // "-_help" is required to run sfdcPage.setHelp

            span.appendChild(img);

            let $sectionHeaderDiv = jQuery('div[id$="' + sectionId + '"]').children().first();
            $sectionHeaderDiv.append(span);

            // when element is created, hint popup needs to be defined
            if (sfdcPage && typeof sfdcPage.setHelp === "function") {
                sfdcPage.setHelp(randomId, hint);
            }
        }

        return {
            setHelpHint: function(sectionId, hint) {
                setHelpHint(sectionId, hint);
            }
        }
    })({!isLightningTheme});

    function removeInlineEditFocus() {
        jQuery("#removeInlineEditFocus").trigger("click");
    }

    var ChangeOwner = (function(oppId, currentOwnerId) {
        let newOwnerId,
            newOwnerName,
            $dialog = jQuery('#change-owner-dialog'),
            $errorModal = $dialog.find('#error-modal-id'),
            $listBox = $dialog.find('#listbox-id'),
            $comboBox = $dialog.find('#combobox-id'),
            $spinner_s = $dialog.find('#os-spinner-small'); // used for input field
            $spinner_l = $dialog.find('#os-spinner-large'); // used for whole modal dialog

        let doSearch = function(searchString) {
            toggleSpinner();
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.OpportunityEditExt.searchSalesUsers}',
                searchString,
                function(result, event) {
                    if (event.status && event.statusCode === 200) {
                        drawUserLookupList(result);
                        toggleSpinner();
                    } else if (event.type === 'exception') {
                        showError('An error has occured: ' + event.message + '.');
                    } else {
                        showError('Something bad happened. Please contact your administrator.');
                        console.error(event);
                    }
                },
                {escape: true}
            );
        };

        let selectNewOwner = function(recId, userName) {
            newOwnerId = recId;
            newOwnerName = userName;
            $listBox.hide(); // hide Users list
            $comboBox.val(userName); // display User Name in input
        };

        let drawUserLookupList = function(userList) {
            $listBox.empty();

            let ul = document.createElement("ul");
            ul.className = "slds-listbox slds-listbox_vertical";
            ul.role = "presentation";

            if (!userList || userList.length === 0) {
                let li = document.createElement("li");
                li.role = "presentation";
                li.className = "slds-listbox__item";

                let div = document.createElement("div");
                div.role = "option";
                div.className = "slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta";

                let spanBody = document.createElement("span");
                spanBody.className = "slds-media__body";

                let spanOption = document.createElement("span");
                spanOption.className = "slds-listbox__option-text slds-listbox__option-text_entity";
                spanOption.innerHTML = "No matches.";

                spanBody.appendChild(spanOption);
                div.appendChild(spanBody);
                li.appendChild(div);

                ul.appendChild(li);
            } else {
                for (let i = 0; i < userList.length; i++) {
                    let li = document.createElement("li");
                    li.role = "presentation";
                    li.className = "slds-listbox__item";

                    let div = document.createElement("div");
                    div.role = "option";
                    div.className = "slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta";
                    div.id = userList[i].Id;
                    div.onclick = function () {
                        selectNewOwner(this.id, userList[i].Name);
                    };

                    let spanBody = document.createElement("span");
                    spanBody.className = "slds-media__body";

                    let spanOption = document.createElement("span");
                    spanOption.className = "slds-listbox__option-text slds-listbox__option-text_entity";
                    spanOption.innerHTML = userList[i].Name;

                    spanBody.appendChild(spanOption);
                    div.appendChild(spanBody);
                    li.appendChild(div);

                    ul.appendChild(li);
                }
            }

            $listBox.prepend(ul);
            $listBox.show();
        };

        let showError = function(errorMsg) {
            // limit length of the error to look better
            if (errorMsg.length > 100) {
                errorMsg.substring(0, 100);
            }
            $errorModal.find('.bBody p').text(errorMsg);
            $errorModal.show();
        };

        let hideError = function() {
            $errorModal.hide();
        };

        let toggleSpinner = function() {
            if ($spinner_s.is(":visible")) {
                 $spinner_s.hide();
            } else {
                 $spinner_s.show();
            }
        };

        let disableDialog = function() {
            $comboBox.attr("disabled","disabled");
            $dialog.find(":button").attr("disabled","disabled");
            $spinner_l.show();
        };

        let enableDialog = function() {
            $comboBox.removeAttr("disabled");
            $dialog.find(":button").removeAttr("disabled","disabled");
            $spinner_l.hide();
        };

        return {
            dialog: function() {
                hideError();
                $dialog.removeClass('slds-hide');
            },

            close: function() {
                $dialog.addClass('slds-hide');
                hideError();
            },

            submit: function() {
                if (!newOwnerId) {
                    showError('Enter a new owner for this record.');
                    return false;
                }

                if (newOwnerId.indexOf(currentOwnerId) > -1) {
                    showError(newOwnerName + ' already owns this record.');
                    return false;
                }

                disableDialog();
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.OpportunityEditExt.updateOwner}',
                    oppId,
                    newOwnerId,
                    function(result, event) {
                        if (event.status && event.statusCode === 200) {
                            if ($A && $A !== undefined && typeof $A.get === "function") {
                                $A.get('e.force:refreshView').fire();
                            } else {
                                location.reload();
                            }
                        } else if (event.type === 'exception') {
                            showError('An error has occured: ' + event.message + '.');
                            enableDialog();
                        } else {
                            showError('Something bad happened. Please contact your administrator.');
                            console.error(event);
                            enableDialog();
                        }
                    },
                    {escape: true}
                );
            },

            keyHandle: function(elem) {
                $listBox.empty();

                let searchString = elem.value;
                if (searchString !== undefined && searchString.trim().length >= 3) {
                    doSearch(searchString.trim());
                }
            }
        }
    })('{!opp.Id}', '{!opp.OwnerId}');

    </script>
</apex:page>